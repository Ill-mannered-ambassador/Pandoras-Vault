<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Pandora's Access</title>
    <style>
        body { background: #0f0f13; color: #e4e4e7; font-family: monospace; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .container { width: 350px; background: #18181b; padding: 2rem; border: 1px solid #27272a; border-radius: 8px; box-shadow: 0 0 20px rgba(16, 185, 129, 0.1); }
        h2 { text-align: center; color: #10b981; margin-top: 0; font-family: 'Courier New', Courier, monospace; letter-spacing: 2px; }
        input { width: 100%; padding: 10px; margin: 8px 0; background: #09090b; border: 1px solid #3f3f46; color: #fff; box-sizing: border-box; }
        input:focus { outline: none; border-color: #10b981; }
        button { width: 100%; padding: 10px; background: #10b981; color: #000; font-weight: bold; border: none; cursor: pointer; margin-top: 10px; }
        button:hover { background: #059669; }
        .switch-btn { background: none; border: none; color: #71717a; width: 100%; margin-top: 15px; cursor: pointer; text-decoration: underline; font-size: 0.9em; }
        .hidden { display: none; }
        .flash { color: #ef4444; text-align: center; margin-bottom: 10px; }

        /* MATRIX LOADER CSS */
        #loader-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0f0f13; z-index: 9999; display: flex; justify-content: center; align-items: center; transition: opacity 0.5s ease-out; }
        .loader-hidden { opacity: 0; pointer-events: none; }

        .ai-matrix-loader { width: 120px; height: 160px; position: relative; perspective: 800px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; }
        .digit { color: #00ff88; font-family: monospace; font-size: 18px; text-align: center; text-shadow: 0 0 5px #00ff88; animation: matrix-fall 2s infinite, matrix-flicker 0.5s infinite; opacity: 0; }
        .digit:nth-child(1) { animation-delay: 0.1s; } .digit:nth-child(2) { animation-delay: 0.3s; } .digit:nth-child(3) { animation-delay: 0.5s; }
        .digit:nth-child(4) { animation-delay: 0.7s; } .digit:nth-child(5) { animation-delay: 0.9s; } .digit:nth-child(6) { animation-delay: 1.1s; }
        .digit:nth-child(7) { animation-delay: 1.3s; } .digit:nth-child(8) { animation-delay: 1.5s; }
        .glow { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: radial-gradient(circle, rgba(0, 255, 136, 0.1) 0%, transparent 70%); animation: matrix-pulse 2s infinite; }
        
        @keyframes matrix-fall { 0% { transform: translateY(-50px) rotateX(90deg); opacity: 0; } 20%, 80% { transform: translateY(0) rotateX(0deg); opacity: 0.8; } 100% { transform: translateY(50px) rotateX(-90deg); opacity: 0; } }
        @keyframes matrix-flicker { 0%, 19%, 21%, 100% { opacity: 0.8; } 20% { opacity: 0.2; } }
        @keyframes matrix-pulse { 0%, 100% { opacity: 0.3; } 50% { opacity: 0.7; } }
    </style>
    <script>
        window.addEventListener("load", () => setTimeout(() => document.getElementById("loader-overlay").classList.add("loader-hidden"), 800));
        function showLoader() { document.getElementById("loader-overlay").classList.remove("loader-hidden"); }
    </script>
</head>
<body>

<div id="loader-overlay">
    <div class="ai-matrix-loader">
        <div class="digit">0</div><div class="digit">1</div><div class="digit">0</div>
        <div class="digit">1</div><div class="digit">1</div><div class="digit">0</div>
        <div class="digit">0</div><div class="digit">1</div>
        <div class="glow"></div>
    </div>
</div>

<div class="container">
    <h2>PANDORA'S VAULT</h2>
    
    {% with messages = get_flashed_messages() %}
        {% if messages %}
            <div class="flash">{{ messages[0] }}</div>
        {% endif %}
    {% endwith %}

    <div id="login-box">
        <form action="/login" method="POST" onsubmit="showLoader()">
            <input type="text" name="username" placeholder="Username" required>
            <input type="password" name="password" placeholder="Password" required>
            <button type="submit">ACCESS VAULT >></button>
        </form>
        <button class="switch-btn" onclick="toggleAuth()">New User? Initialize Protocol</button>
    </div>

    <div id="signup-box" class="hidden">
        <form action="/signup" method="POST" onsubmit="showLoader()">
            <input type="text" name="username" placeholder="Choose Callsign" required>
            <input type="email" name="email" placeholder="Comms Frequency (Email)" required>
            <input type="password" name="password" placeholder="Set Cipher Key" required>
            <button type="submit">REGISTER IDENTITY</button>
        </form>
        <button class="switch-btn" onclick="toggleAuth()">Return to Login</button>
    </div>
</div>

<script>
    // --- UTILITY: ArrayBuffer to Base64 ---
    function arrayBufferToBase64(buffer) {
        let binary = '';
        const bytes = new Uint8Array(buffer);
        const len = bytes.byteLength;
        for (let i = 0; i < len; i++) {
            binary += String.fromCharCode(bytes[i]);
        }
        return window.btoa(binary);
    }

    // --- RSA KEY GENERATION ---
    async function generateIdentity(event) {
        event.preventDefault(); // Stop normal form submission
        showLoader();

        const form = event.target;
        const formData = new FormData(form);

        console.log("Generating 2048-bit RSA Keypair...");

        // 1. Generate Key Pair
        const keyPair = await window.crypto.subtle.generateKey(
            {
                name: "RSA-OAEP",
                modulusLength: 2048,
                publicExponent: new Uint8Array([1, 0, 1]),
                hash: "SHA-256"
            },
            true,
            ["encrypt", "decrypt"]
        );

        // 2. Export Keys
        const publicKeyBuffer = await window.crypto.subtle.exportKey("spki", keyPair.publicKey);
        const privateKeyBuffer = await window.crypto.subtle.exportKey("pkcs8", keyPair.privateKey);

        const publicKeyB64 = arrayBufferToBase64(publicKeyBuffer);
        const privateKeyB64 = arrayBufferToBase64(privateKeyBuffer);

        // 3. SAVE PRIVATE KEY LOCALLY (The "Identity")
        // Server NEVER sees this.
        localStorage.setItem("my_private_key", privateKeyB64);
        console.log("Private Key saved to browser storage.");

        // 4. ATTACH PUBLIC KEY TO FORM
        formData.append("public_key", publicKeyB64);

        // 5. SUBMIT TO SERVER
        try {
            const response = await fetch('/signup', {
                method: 'POST',
                body: formData
            });

            if (response.redirected) {
                window.location.href = response.url;
            } else {
                window.location.reload();
            }
        } catch (e) {
            alert("Signup Error: " + e.message);
            document.getElementById("loader-overlay").classList.add("loader-hidden");
        }
    }

    // ATTACH TO SIGNUP FORM
    // Wait for DOM to load
    document.addEventListener("DOMContentLoaded", () => {
        const signupForm = document.querySelector('#signup-box form');
        if (signupForm) {
            signupForm.addEventListener('submit', generateIdentity);
        }
    });

    // --- UI HELPERS ---
    window.addEventListener("load", () => setTimeout(() => document.getElementById("loader-overlay").classList.add("loader-hidden"), 800));
    function showLoader() { document.getElementById("loader-overlay").classList.remove("loader-hidden"); }
    
    function toggleAuth() {
        document.getElementById('login-box').classList.toggle('hidden');
        document.getElementById('signup-box').classList.toggle('hidden');
    }
</script>

</body>
</html>