<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Pandora's Vault</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        #toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 10000;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    /* INDIVIDUAL TOAST */
    .toast {
        background: #18181b;
        color: #e4e4e7;
        padding: 12px 20px;
        border-left: 4px solid #10b981; /* Green accent */
        border-radius: 4px;
        font-family: 'JetBrains Mono', monospace;
        font-size: 0.9rem;
        box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        min-width: 250px;
        animation: slideIn 0.3s ease-out forwards;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .toast.error { border-left-color: #ef4444; } /* Red for errors */
    .toast.info { border-left-color: #3b82f6; }  /* Blue for info */

    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }

    @keyframes fadeOut {
        to { opacity: 0; transform: translateX(100%); }
    }
        :root { --bg: #0f0f13; --card-bg: #18181b; --accent: #10b981; --text: #e4e4e7; --text-muted: #a1a1aa; --border: #27272a; }
        body { font-family: 'JetBrains Mono', monospace; background: var(--bg); color: var(--text); margin: 0; padding: 2rem; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; border-bottom: 1px solid var(--border); padding-bottom: 1rem; }
        h1 { margin: 0; font-size: 1.5rem; color: var(--accent); letter-spacing: 2px; text-shadow: 0 0 10px rgba(16, 185, 129, 0.3); }
        .container { max-width: 1000px; margin: 0 auto; }
        
        .section { background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; }
        .file-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem; margin-top: 1rem; }
        .file-card { background: #222; border: 1px solid var(--border); padding: 1rem; border-radius: 8px; transition: transform 0.2s; }
        .file-card:hover { transform: translateY(-2px); border-color: var(--accent); }
        .file-name { font-weight: bold; margin-bottom: 0.5rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; }
        
        .badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; }
        .badge-owner { background: #3b82f6; color: #fff; }
        .badge-viewer { background: #6b7280; color: #fff; }
        .badge-editor { background: #f59e0b; color: #000; }
        .badge-revoked { background: #ef4444; color: #fff; }

        button { cursor: pointer; border: none; border-radius: 6px; padding: 8px 16px; font-weight: bold; }
        .btn-primary { background: var(--accent); color: #000; }
        .btn-icon { background: #333; color: #fff; padding: 6px 10px; font-size: 0.9rem; }
        .btn-icon:hover { background: #444; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal { background: var(--card-bg); padding: 2rem; border-radius: 12px; width: 400px; border: 1px solid var(--border); }
        .user-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border); }
        
        #log { font-size: 0.8rem; height: 100px; overflow-y: auto; color: var(--text-muted); border-top: 1px solid var(--border); padding-top: 10px; }
        a { color: var(--accent); text-decoration: none; }

        /* MATRIX LOADER CSS */
        #loader-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0f0f13; z-index: 9999; display: flex; justify-content: center; align-items: center; transition: opacity 0.5s ease-out; }
        .loader-hidden { opacity: 0; pointer-events: none; }

        .ai-matrix-loader { width: 120px; height: 160px; position: relative; perspective: 800px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; }
        .digit { color: #00ff88; font-family: monospace; font-size: 18px; text-align: center; text-shadow: 0 0 5px #00ff88; animation: matrix-fall 2s infinite, matrix-flicker 0.5s infinite; opacity: 0; }
        .digit:nth-child(1) { animation-delay: 0.1s; } .digit:nth-child(2) { animation-delay: 0.3s; } .digit:nth-child(3) { animation-delay: 0.5s; }
        .digit:nth-child(4) { animation-delay: 0.7s; } .digit:nth-child(5) { animation-delay: 0.9s; } .digit:nth-child(6) { animation-delay: 1.1s; }
        .digit:nth-child(7) { animation-delay: 1.3s; } .digit:nth-child(8) { animation-delay: 1.5s; }
        .glow { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: radial-gradient(circle, rgba(0, 255, 136, 0.1) 0%, transparent 70%); animation: matrix-pulse 2s infinite; }
        
        @keyframes matrix-fall { 0% { transform: translateY(-50px) rotateX(90deg); opacity: 0; } 20%, 80% { transform: translateY(0) rotateX(0deg); opacity: 0.8; } 100% { transform: translateY(50px) rotateX(-90deg); opacity: 0; } }
        @keyframes matrix-flicker { 0%, 19%, 21%, 100% { opacity: 0.8; } 20% { opacity: 0.2; } }
        @keyframes matrix-pulse { 0%, 100% { opacity: 0.3; } 50% { opacity: 0.7; } }
    </style>
    <script>
        window.addEventListener("load", () => setTimeout(() => document.getElementById("loader-overlay").classList.add("loader-hidden"), 800));
        function showLoader() { document.getElementById("loader-overlay").classList.remove("loader-hidden"); }
        // REPLACE alert() WITH THIS
        window.showToast = (message, type = 'success') => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerText = `> ${message}`;
    
            container.appendChild(toast);
    
            // Remove after 3 seconds
            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.5s ease-out forwards';
                setTimeout(() => toast.remove(), 500);
            }, 3000);
        };

// OVERRIDE DEFAULT ALERT (Optional, lazy way to fix all alerts at once)
window.alert = (msg) => showToast(msg, 'error');
    </script>
</head>
<body>
    <div id="toast-container"></div>
    <div id="loader-overlay">
        <div class="ai-matrix-loader">
            <div class="digit">0</div><div class="digit">1</div><div class="digit">0</div>
            <div class="digit">1</div><div class="digit">1</div><div class="digit">0</div>
            <div class="digit">0</div><div class="digit">1</div>
            <div class="glow"></div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>PANDORA'S VAULT</h1>
            <div>
                <span style="color: var(--text-muted);">Operator: {{ user }}</span>
                <a href="/logout" onclick="showLoader()" style="color: #ef4444; margin-left: 10px;">[DISCONNECT]</a>
            </div>
        </div>

        {% if trap_mode == 1 %}
        <div class="section">
            <h3>Secure Upload Protocol</h3>
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <input type="file" id="fileInput" style="background: #222; color: #fff; padding: 10px; border: 1px solid #444; width: 100%;">
                <button class="btn-primary" onclick="startUpload()">ENCRYPT & UPLOAD</button>
                <input type="file" id="updateInput" style="display: none;" onchange="confirmUpdate()">
            </div>
        </div>
        {% endif %}

        <div class="section">
            <div style="display:flex; justify-content:space-between;">
                <h3>Encrypted Archives</h3>
                {% if trap_mode == 1 %}
                    <a href="/audit_logs" onclick="showLoader()" style="font-size:0.8rem;">ACCESS LOGS -></a>
                {% endif %}
            </div>
            
            <div class="file-grid">
                {% if files %}
                    {% for file in files %}
                    <div class="file-card">
                        <span class="file-name">{{ file['filename'] }}</span>
                        
                        {% if trap_mode == 1 %}
                        <div><span class="badge badge-{{ file['role'] }}">{{ file['role'] }}</span></div>
                        {% endif %}
                        
                        <div style="display: flex; gap: 5px; margin-top: 10px;">
                            <button class="btn-icon" data-file="{{ file['filename'] }}" onclick="startDownload(this.dataset.file)">â¬‡</button>
                            
                            {% if trap_mode == 1 %}
                                {% if file['role'] in ['owner', 'editor'] %}
                                    <button class="btn-icon" 
                                            data-file="{{ file['filename'] }}" 
                                            data-role="{{ file['role'] }}"
                                            data-source="{{ file['source_filename'] }}"
                                            data-owner="{{ file['shared_from'] if file['role'] == 'editor' else file['owner_username'] }}"
                                            onclick="triggerUpdate(this.dataset)">Update</button>

                                    <button class="btn-icon" data-file="{{ file['filename'] }}" onclick="openShareModal(this.dataset.file)">Share</button>
                                {% endif %}
                                
                                {% if file['role'] == 'owner' %}
                                    <button class="btn-icon" data-file="{{ file['filename'] }}" onclick="openManageModal(this.dataset.file)">Manage</button>
                                {% endif %}
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p style="color: var(--text-muted);">No archives found.</p>
                {% endif %}
            </div>
        </div>

        <div class="section">
            <h3>Terminal Output</h3>
            <div id="log">System Initialized...</div>
        </div>
    </div>

    <div id="shareModal" class="modal-overlay">
        <div class="modal">
            <h2 style="color: var(--accent); margin-top: 0;">Establish Link</h2>
            <p id="shareFileName" style="color: #888;"></p>
            <input type="text" id="shareTargetUser" placeholder="Target Callsign" style="width: 100%; padding: 10px; background: #000; color: #fff; border: 1px solid #444;">
            <div style="margin-top: 15px; text-align: right;">
                <button class="btn-icon" onclick="document.getElementById('shareModal').style.display='none'">Abort</button>
                <button class="btn-primary" onclick="confirmShare()">Transmit</button>
            </div>
        </div>
    </div>

    <div id="manageModal" class="modal-overlay">
        <div class="modal">
            <h2 style="color: var(--accent); margin-top: 0;">Access Control</h2>
            <div id="userList" style="margin-top: 10px;"></div>
            <div style="margin-top: 15px; text-align: right;">
                <button class="btn-icon" onclick="document.getElementById('manageModal').style.display='none'">Close</button>
            </div>
        </div>
    </div>

    <script src="/static/cipher.js"></script>
    <script>
        // REPLACE alert() WITH THIS
        window.showToast = (message, type = 'success') => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerText = `> ${message}`;
    
            container.appendChild(toast);
    
            // Remove after 3 seconds
            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.5s ease-out forwards';
                setTimeout(() => toast.remove(), 500);
            }, 3000);
        };

        // OVERRIDE DEFAULT ALERT (Optional, lazy way to fix all alerts at once)
        window.alert = (msg) => showToast(msg, 'error');
                // GLOBALS
                let CURRENT_FILE = null;
                let UPDATE_MASTER_FILE = null;
                let UPDATE_MASTER_KEY = null;
                let UPDATE_MY_FILE = null;

                // SAFE CONFIG LOAD
                const CONFIG = {
                    trapKey: "{{ trap_key }}" || "",
                    trapMode: parseInt("{{ trap_mode }}") || 0
                };

                function log(msg) {
                    const el = document.getElementById('log');
                    if(el) { el.innerHTML += `<div style="margin-top:2px; color:#aaa;">> ${msg}</div>`; el.scrollTop = el.scrollHeight; }
                }
            
                if (typeof Module !== 'undefined') {
                    Module.onRuntimeInitialized = () => log(`Cipher Engine: ${CONFIG.trapMode === 1 ? 'ONLINE' : 'RESTRICTED'}`);
                }

        // --- CRYPTO WRAPPERS ---
        window.wasmEncrypt = function(jsArray, keyStr) {
            const encoder = new TextEncoder();
            const passBytes = encoder.encode(keyStr);
            const dataPtr = Module._malloc(jsArray.length);
            const passPtr = Module._malloc(passBytes.length + 1);
            try {
                Module.HEAPU8.set(jsArray, dataPtr);
                Module.HEAPU8.set(passBytes, passPtr);
                Module.HEAPU8[passPtr + passBytes.length] = 0;
                Module._wasm_encrypt_file(dataPtr, jsArray.length, passPtr);
                return new Uint8Array(Module.HEAPU8.buffer, dataPtr, jsArray.length).slice(0);
            } finally { Module._free(dataPtr); Module._free(passPtr); }
        };

        window.wasmDecrypt = function(jsArray, keyStr, mode) {
            const encoder = new TextEncoder();
            const passBytes = encoder.encode(keyStr);
            const dataPtr = Module._malloc(jsArray.length);
            const passPtr = Module._malloc(passBytes.length + 1);
            try {
                Module.HEAPU8.set(jsArray, dataPtr);
                Module.HEAPU8.set(passBytes, passPtr);
                Module.HEAPU8[passPtr + passBytes.length] = 0;
                Module._wasm_decrypt_file(dataPtr, jsArray.length, passPtr, mode);
                return new Uint8Array(Module.HEAPU8.buffer, dataPtr, jsArray.length).slice(0);
            } finally { Module._free(dataPtr); Module._free(passPtr); }
        };

        // --- UPLOAD ---
        window.startUpload = async function() {
            const file = document.getElementById('fileInput').files[0];
            if(!file) return alert("Select File");
            log("Encoding binary stream...");
            const raw = new Uint8Array(await file.arrayBuffer());
            const enc = window.wasmEncrypt(raw, CONFIG.trapKey);
            const fd = new FormData();
            fd.append('file', new Blob([enc]), file.name + ".enc");
            await fetch('/upload', { method:'POST', body:fd });
            log("Transmission Complete.");
            setTimeout(() => location.reload(), 500);
        };

        // --- UPDATE (SYNC LOGIC) ---
        window.triggerUpdate = async (data) => {
            const role = data.role;
            const currentFile = data.file; // My file
            const sourceFile = data.source; // Alice's file
            const ownerName = data.owner;

            UPDATE_MY_FILE = currentFile; 

            if (role === 'owner') {
                UPDATE_MASTER_FILE = currentFile;
                UPDATE_MASTER_KEY = CONFIG.trapKey;
                document.getElementById('updateInput').click();
            } else if (role === 'editor') {
                UPDATE_MASTER_FILE = sourceFile; 
                if(!UPDATE_MASTER_FILE || UPDATE_MASTER_FILE === "None") UPDATE_MASTER_FILE = currentFile;

                log(`Requesting write access for ${ownerName}...`);
                try {
                    const kResp = await fetch(`/get_share_key/${ownerName}`);
                    if(!kResp.ok) throw new Error("Key fetch failed");
                    UPDATE_MASTER_KEY = await kResp.text();
                    document.getElementById('updateInput').click();
                } catch(e) { alert("Authorization Failed."); }
            }
        };

        window.confirmUpdate = async () => {
            const fileInput = document.getElementById('updateInput');
            const file = fileInput.files[0];
            if(!file) return;
            
            if(!confirm(`Overwrite archive content and sync to network?`)) { fileInput.value = ''; return; }

            log(`Initiating Network Sync...`);
            try {
                const raw = new Uint8Array(await file.arrayBuffer());
                
                // 1. Get List of ALL people who have this file
                // Parse Master Owner from filename: "Alice_123_File.enc"
                const masterOwner = UPDATE_MASTER_FILE.split('_')[0];
                const userListResp = await fetch(`/get_file_users/${UPDATE_MASTER_FILE}`);
                let targets = await userListResp.json();
                
                // Add Master to target list manually
                targets.push({ owner_username: masterOwner, filename: UPDATE_MASTER_FILE });

                for (let t of targets) {
                    if(t.role === 'revoked') continue;
                    log(`Syncing node: ${t.owner_username}...`);
                    
                    const kResp = await fetch(`/get_share_key/${t.owner_username}`);
                    if(!kResp.ok) continue;
                    const targetKey = await kResp.text();
                    
                    const enc = window.wasmEncrypt(raw, targetKey);
                    const fd = new FormData();
                    fd.append('file', new Blob([enc]), file.name); 
                    fd.append('filename', t.filename); 
                    
                    await fetch('/update_file', { method:'POST', body:fd });
                }

                log("Network Synchronization Complete.");
                setTimeout(() => location.reload(), 1000);

            } catch(e) { log("Sync Error: " + e.message); }
            fileInput.value = '';
        };

        // --- DOWNLOAD ---
        window.startDownload = async function(filename) {
            log(`Retrieving ${filename}...`);
            const r = await fetch(`/download/${filename}?t=${Date.now()}`);
            if(!r.ok) return alert("Access Denied");
            
            const enc = new Uint8Array(await r.arrayBuffer());
            log(`Decrypting (Mode: ${CONFIG.trapMode})...`);
            
            try {
                const dec = window.wasmDecrypt(enc, CONFIG.trapKey, CONFIG.trapMode);
                const url = URL.createObjectURL(new Blob([dec]));
                const a = document.createElement('a');
                a.href = url; 
                a.download = filename.replace(".enc", "") + "_v" + Date.now() + ".txt"; 
                a.click();
            } catch(e) { log("Decryption Error."); }
        };

        // --- SHARE ---
        window.openShareModal = (f) => {
            CURRENT_FILE = f;
            document.getElementById('shareFileName').innerText = f;
            document.getElementById('shareModal').style.display = 'flex';
        };

        window.confirmShare = async () => {
            const target = document.getElementById('shareTargetUser').value;
            if(!target) return;
            log(`Establishing link with ${target}...`);
            try {
                const kResp = await fetch(`/get_share_key/${target}`);
                if(!kResp.ok) throw new Error("User not found");
                const targetKey = await kResp.text();
                
                const fResp = await fetch(`/download/${CURRENT_FILE}`);
                const srcBytes = new Uint8Array(await fResp.arrayBuffer());
                
                const temp = window.wasmDecrypt(srcBytes, CONFIG.trapKey, CONFIG.trapMode);
                const final = window.wasmEncrypt(temp, targetKey);
                
                const fd = new FormData();
                const cleanName = CURRENT_FILE.split('_').slice(2).join('_');
                fd.append('file', new Blob([final]), cleanName);
                fd.append('target_user', target);
                fd.append('original_filename', CURRENT_FILE);
                
                await fetch('/share_file', { method:'POST', body:fd });
                log("Link Established.");
                document.getElementById('shareModal').style.display='none';
            } catch(e) { log(e.message); }
        };

        // --- MANAGE ---
        window.openManageModal = async (f) => {
            CURRENT_FILE = f;
            const modal = document.getElementById('manageModal');
            const list = document.getElementById('userList');
            
            modal.style.display = 'flex';
            list.innerHTML = "<p style='color:#666'>Scanning permissions...</p>";
            
            try {
                const r = await fetch(`/get_file_users/${f}`);
                const users = await r.json();
                
                list.innerHTML = "";
                if(users.length === 0) {
                    list.innerHTML = "<p style='color:#666'>No active links.</p>";
                    return;
                }
                
                users.forEach(u => {
                    const div = document.createElement('div');
                    div.className = 'user-row';
                    div.innerHTML = `
                        <span style="color:#fff">${u.owner_username}</span>
                        <select onchange="changeRole('${u.filename}', this.value)" style="background:#222; color:#fff; padding:5px;">
                            <option value="viewer" ${u.role==='viewer'?'selected':''}>Viewer</option>
                            <option value="editor" ${u.role==='editor'?'selected':''}>Editor</option>
                            <option value="revoked" ${u.role==='revoked'?'selected':''}>Revoke</option>
                        </select>
                    `;
                    list.appendChild(div);
                });
            } catch(e) { list.innerHTML = "Error loading."; }
        };

        window.changeRole = async (f, r) => {
            await fetch('/update_role', { 
                method:'POST', 
                headers:{'Content-Type':'application/json'},
                body: JSON.stringify({ filename: f, role: r }) 
            });
            log("Privileges updated.");
        };
    </script>
</body>
</html>