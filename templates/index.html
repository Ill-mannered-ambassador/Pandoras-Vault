<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Pandora's Vault</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: #18181b; color: #e4e4e7; padding: 12px 20px; border-left: 4px solid #10b981; border-radius: 4px; font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; box-shadow: 0 5px 15px rgba(0,0,0,0.5); min-width: 250px; animation: slideIn 0.3s ease-out forwards; display: flex; align-items: center; justify-content: space-between; }
        .toast.error { border-left-color: #ef4444; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { to { opacity: 0; transform: translateX(100%); } }
        :root { --bg: #0f0f13; --card-bg: #18181b; --accent: #10b981; --text: #e4e4e7; --text-muted: #a1a1aa; --border: #27272a; }
        body { font-family: 'JetBrains Mono', monospace; background: var(--bg); color: var(--text); margin: 0; padding: 2rem; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; border-bottom: 1px solid var(--border); padding-bottom: 1rem; }
        h1 { margin: 0; font-size: 1.5rem; color: var(--accent); letter-spacing: 2px; text-shadow: 0 0 10px rgba(16, 185, 129, 0.3); }
        .container { max-width: 1000px; margin: 0 auto; }
        .section { background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; }
        .file-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem; margin-top: 1rem; }
        .file-card { background: #222; border: 1px solid var(--border); padding: 1rem; border-radius: 8px; transition: transform 0.2s; }
        .file-card:hover { transform: translateY(-2px); border-color: var(--accent); }
        .file-name { font-weight: bold; margin-bottom: 0.5rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; }
        .badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; }
        .badge-owner { background: #3b82f6; color: #fff; }
        .badge-viewer { background: #6b7280; color: #fff; }
        .badge-editor { background: #f59e0b; color: #000; }
        .badge-revoked { background: #ef4444; color: #fff; }
        button { cursor: pointer; border: none; border-radius: 6px; padding: 8px 16px; font-weight: bold; }
        .btn-primary { background: var(--accent); color: #000; }
        .btn-icon { background: #333; color: #fff; padding: 6px 10px; font-size: 0.9rem; }
        .btn-icon:hover { background: #444; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal { background: var(--card-bg); padding: 2rem; border-radius: 12px; width: 400px; border: 1px solid var(--border); }
        .user-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border); }
        #log { font-size: 0.8rem; height: 100px; overflow-y: auto; color: var(--text-muted); border-top: 1px solid var(--border); padding-top: 10px; }
        a { color: var(--accent); text-decoration: none; }
        #loader-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0f0f13; z-index: 9999; display: flex; justify-content: center; align-items: center; transition: opacity 0.5s ease-out; }
        .loader-hidden { opacity: 0; pointer-events: none; }
        .ai-matrix-loader { width: 120px; height: 160px; position: relative; perspective: 800px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; }
        .digit { color: #00ff88; font-family: monospace; font-size: 18px; text-align: center; text-shadow: 0 0 5px #00ff88; animation: matrix-fall 2s infinite, matrix-flicker 0.5s infinite; opacity: 0; }
        .digit:nth-child(1) { animation-delay: 0.1s; } .digit:nth-child(2) { animation-delay: 0.3s; } .digit:nth-child(3) { animation-delay: 0.5s; }
        .digit:nth-child(4) { animation-delay: 0.7s; } .digit:nth-child(5) { animation-delay: 0.9s; } .digit:nth-child(6) { animation-delay: 1.1s; }
        .digit:nth-child(7) { animation-delay: 1.3s; } .digit:nth-child(8) { animation-delay: 1.5s; }
        .glow { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: radial-gradient(circle, rgba(0, 255, 136, 0.1) 0%, transparent 70%); animation: matrix-pulse 2s infinite; }
        @keyframes matrix-fall { 0% { transform: translateY(-50px) rotateX(90deg); opacity: 0; } 20%, 80% { transform: translateY(0) rotateX(0deg); opacity: 0.8; } 100% { transform: translateY(50px) rotateX(-90deg); opacity: 0; } }
        @keyframes matrix-flicker { 0%, 19%, 21%, 100% { opacity: 0.8; } 20% { opacity: 0.2; } }
        @keyframes matrix-pulse { 0%, 100% { opacity: 0.3; } 50% { opacity: 0.7; } }
    </style>
</head>
<body>
    <div id="toast-container"></div>
    <div id="loader-overlay">
        <div class="ai-matrix-loader">
            <div class="digit">0</div><div class="digit">1</div><div class="digit">0</div>
            <div class="digit">1</div><div class="digit">1</div><div class="digit">0</div>
            <div class="digit">0</div><div class="digit">1</div>
            <div class="glow"></div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>PANDORA'S VAULT</h1>
            <div>
                <span style="color: var(--text-muted);">Operator: {{ user }}</span>
                <a href="/logout" onclick="showLoader()" style="color: #ef4444; margin-left: 10px;">[DISCONNECT]</a>
            </div>
        </div>

        {% if trap_mode == 1 %}
        <div class="section">
            <h3>Secure Upload Protocol</h3>
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <input type="file" id="fileInput" style="background: #222; color: #fff; padding: 10px; border: 1px solid #444; width: 100%;">
                <button class="btn-primary" onclick="startUpload()">ENCRYPT & UPLOAD</button>
                <input type="file" id="updateInput" style="display: none;" onchange="confirmUpdate()">
            </div>
        </div>
        {% endif %}

        <div class="section">
            <div style="display:flex; justify-content:space-between;">
                <h3>Encrypted Archives</h3>
                {% if trap_mode == 1 %}
                    <a href="/audit_logs" onclick="showLoader()" style="font-size:0.8rem;">ACCESS LOGS -></a>
                {% endif %}
            </div>
            
            <div class="file-grid">
                {% if files %}
                    {% for file in files %}
                    <div class="file-card">
                        <span class="file-name">{{ file['filename'] }}</span>
                        
                        {% if trap_mode == 1 %}
                        <div><span class="badge badge-{{ file['role'] }}">{{ file['role'] }}</span></div>
                        {% endif %}
                        
                        <div style="display: flex; gap: 5px; margin-top: 10px;">
                            <button class="btn-icon" 
                                    onclick="startDownload('{{ file['filename'] }}', '{{ file['encrypted_key'] }}')">â¬‡</button>
                            
                            {% if trap_mode == 1 %}
                                {% if file['role'] in ['owner', 'editor'] %}
                                    <button class="btn-icon" 
                                            data-file="{{ file['filename'] }}" 
                                            data-key="{{ file['encrypted_key'] }}"
                                            onclick="triggerUpdate(this.dataset)">Update</button>

                                    <button class="btn-icon" 
                                            onclick="openShareModal('{{ file['filename'] }}', '{{ file['encrypted_key'] }}')">Share</button>
                                {% endif %}
                                
                                {% if file['role'] == 'owner' %}
                                    <button class="btn-icon" onclick="openManageModal('{{ file['filename'] }}')">Manage</button>
                                {% endif %}
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p style="color: var(--text-muted);">No archives found.</p>
                {% endif %}
            </div>
        </div>

        <div class="section">
            <h3>Terminal Output</h3>
            <div id="log">System Initialized...</div>
        </div>
    </div>

    <div id="shareModal" class="modal-overlay">
        <div class="modal">
            <h2 style="color: var(--accent); margin-top: 0;">Establish Link</h2>
            <p id="shareFileName" style="color: #888;"></p>
            <input type="text" id="shareTargetUser" placeholder="Target Callsign" style="width: 100%; padding: 10px; background: #000; color: #fff; border: 1px solid #444;">
            <div style="margin-top: 15px; text-align: right;">
                <button class="btn-icon" onclick="document.getElementById('shareModal').style.display='none'">Abort</button>
                <button class="btn-primary" onclick="confirmShare()">Transmit</button>
            </div>
        </div>
    </div>

    <div id="manageModal" class="modal-overlay">
        <div class="modal">
            <h2 style="color: var(--accent); margin-top: 0;">Access Control</h2>
            <div id="userList" style="margin-top: 10px;"></div>
            <div style="margin-top: 15px; text-align: right;">
                <button class="btn-icon" onclick="document.getElementById('manageModal').style.display='none'">Close</button>
            </div>
        </div>
    </div>

    <script src="/static/cipher.js"></script>
    <script>
        // ==========================================
        // 1. UI & UTILITY
        // ==========================================
        window.addEventListener("load", () => setTimeout(() => document.getElementById("loader-overlay").classList.add("loader-hidden"), 800));
        function showLoader() { document.getElementById("loader-overlay").classList.remove("loader-hidden"); }
        
        window.showToast = (message, type = 'success') => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerText = `> ${message}`;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.5s ease-out forwards';
                setTimeout(() => toast.remove(), 500);
            }, 3000);
        };
        window.alert = (msg) => showToast(msg, 'error');

        function log(msg) {
            const el = document.getElementById('log');
            if(el) { el.innerHTML += `<div style="margin-top:2px; color:#aaa;">> ${msg}</div>`; el.scrollTop = el.scrollHeight; }
        }

        // ==========================================
        // 2. CONFIGURATION & RSA HELPERS
        // ==========================================
        const CONFIG = {
            trapMode: parseInt("{{ trap_mode }}") || 0
        };
        const CURRENT_USER = "{{ user }}";
        
        let CURRENT_FILE = null;
        let CURRENT_FILE_ENVELOPE = null;
        let UPDATE_TARGET_FILE = null;
        let UPDATE_FILE_KEY = null;

        if (typeof Module !== 'undefined') {
            Module.onRuntimeInitialized = () => log(`Cipher Engine: ${CONFIG.trapMode === 1 ? 'ONLINE' : 'RESTRICTED'}`);
        }

        function arrayBufferToBase64(buffer) {
            let binary = '';
            const bytes = new Uint8Array(buffer);
            for (let i = 0; i < bytes.byteLength; i++) binary += String.fromCharCode(bytes[i]);
            return window.btoa(binary);
        }
        
        function base64ToArrayBuffer(base64) {
            const binary_string = window.atob(base64);
            const len = binary_string.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) bytes[i] = binary_string.charCodeAt(i);
            return bytes.buffer;
        }

        async function importPublicKey(pem) {
            const binaryDer = base64ToArrayBuffer(pem);
            return window.crypto.subtle.importKey("spki", binaryDer, {name: "RSA-OAEP", hash: "SHA-256"}, true, ["encrypt"]);
        }

        async function importPrivateKey(pem) {
            const binaryDer = base64ToArrayBuffer(pem);
            return window.crypto.subtle.importKey("pkcs8", binaryDer, {name: "RSA-OAEP", hash: "SHA-256"}, true, ["decrypt"]);
        }

        // ==========================================
        // 3. WASM WRAPPERS
        // ==========================================
        window.wasmEncrypt = function(jsArray, keyStr) {
            const encoder = new TextEncoder();
            const passBytes = encoder.encode(keyStr);
            const dataPtr = Module._malloc(jsArray.length);
            const passPtr = Module._malloc(passBytes.length + 1);
            try {
                Module.HEAPU8.set(jsArray, dataPtr);
                Module.HEAPU8.set(passBytes, passPtr);
                Module.HEAPU8[passPtr + passBytes.length] = 0;
                Module._wasm_encrypt_file(dataPtr, jsArray.length, passPtr);
                return new Uint8Array(Module.HEAPU8.buffer, dataPtr, jsArray.length).slice(0);
            } finally { Module._free(dataPtr); Module._free(passPtr); }
        };

        window.wasmDecrypt = function(jsArray, keyStr, mode) {
            const encoder = new TextEncoder();
            const passBytes = encoder.encode(keyStr);
            const dataPtr = Module._malloc(jsArray.length);
            const passPtr = Module._malloc(passBytes.length + 1);
            try {
                Module.HEAPU8.set(jsArray, dataPtr);
                Module.HEAPU8.set(passBytes, passPtr);
                Module.HEAPU8[passPtr + passBytes.length] = 0;
                Module._wasm_decrypt_file(dataPtr, jsArray.length, passPtr, mode);
                return new Uint8Array(Module.HEAPU8.buffer, dataPtr, jsArray.length).slice(0);
            } finally { Module._free(dataPtr); Module._free(passPtr); }
        };

        // ==========================================
        // 4. CORE: UPLOAD (Envelope Creation)
        // ==========================================
        window.startUpload = async function() {
            const file = document.getElementById('fileInput').files[0];
            if(!file) return alert("Select File");
            
            log("Generating Random File Key...");
            const randomBytes = new Uint8Array(32);
            window.crypto.getRandomValues(randomBytes);
            const fileKey = arrayBufferToBase64(randomBytes).slice(0, 32); 

            log("Encrypting Payload...");
            const raw = new Uint8Array(await file.arrayBuffer());
            const encFileBlob = window.wasmEncrypt(raw, fileKey);

            log("Sealing Envelope...");
            const myPubKeyStr = await fetch(`/get_public_key/${CURRENT_USER}`).then(r=>r.text());
            const myPubKey = await importPublicKey(myPubKeyStr);
            
            const encKeyBuffer = await window.crypto.subtle.encrypt(
                { name: "RSA-OAEP" },
                myPubKey,
                new TextEncoder().encode(fileKey)
            );
            const encKeyB64 = arrayBufferToBase64(encKeyBuffer);

            const fd = new FormData();
            fd.append('file', new Blob([encFileBlob]), file.name + ".enc");
            fd.append('encrypted_key', encKeyB64);
            
            await fetch('/upload', { method:'POST', body:fd });
            log("Secure Upload Complete.");
            setTimeout(() => location.reload(), 500);
        };

        // ==========================================
        // 5. CORE: DOWNLOAD (Envelope Opening)
        // ==========================================
        window.startDownload = async function(filename, encryptedKeyB64) {
            log(`Retrieving ${filename}...`);
            try {
                const privKeyStr = localStorage.getItem("my_private_key");
                if(!privKeyStr) throw new Error("Private Key Missing! Did you clear cache?");
                const privKey = await importPrivateKey(privKeyStr);

                log("Unsealing Envelope...");
                const keyBuffer = base64ToArrayBuffer(encryptedKeyB64);
                const decryptedKeyBuffer = await window.crypto.subtle.decrypt(
                    { name: "RSA-OAEP" },
                    privKey,
                    keyBuffer
                );
                const fileKey = new TextDecoder().decode(decryptedKeyBuffer);

                const r = await fetch(`/download/${filename}?t=${Date.now()}`);
                if(!r.ok) throw new Error("Download failed");
                const encBytes = new Uint8Array(await r.arrayBuffer());
                
                log(`Decrypting Payload (Mode: ${CONFIG.trapMode})...`);
                const dec = window.wasmDecrypt(encBytes, fileKey, CONFIG.trapMode);
                
                const url = URL.createObjectURL(new Blob([dec]));
                const a = document.createElement('a');
                a.href = url; 
                a.download = filename.replace(".enc", "") + "_v" + Date.now() + ".txt"; 
                a.click();
            } catch(e) { 
                log("Error: " + e.message); 
                alert("Decryption Failed. Are you the owner?");
            }
        };

        // ==========================================
        // 6. CORE: SHARE (Zero-Copy)
        // ==========================================
        window.openShareModal = (f, k) => {
            CURRENT_FILE = f;
            CURRENT_FILE_ENVELOPE = k;
            document.getElementById('shareFileName').innerText = f;
            document.getElementById('shareModal').style.display = 'flex';
        };

        window.confirmShare = async () => {
            const target = document.getElementById('shareTargetUser').value;
            if(!target) return;
            
            try {
                log(`Fetching ${target}'s Public Key...`);
                const kResp = await fetch(`/get_public_key/${target}`);
                if(!kResp.ok) throw new Error("User not found");
                const targetPubKeyStr = await kResp.text();
                const targetPubKey = await importPublicKey(targetPubKeyStr);

                const privKeyStr = localStorage.getItem("my_private_key");
                const privKey = await importPrivateKey(privKeyStr);
                const myEnvelope = base64ToArrayBuffer(CURRENT_FILE_ENVELOPE);
                
                const decryptedKeyBuf = await window.crypto.subtle.decrypt(
                    { name: "RSA-OAEP" },
                    privKey,
                    myEnvelope
                );

                const newEnvelopeBuf = await window.crypto.subtle.encrypt(
                    { name: "RSA-OAEP" },
                    targetPubKey,
                    decryptedKeyBuf 
                );
                const newEnvelopeB64 = arrayBufferToBase64(newEnvelopeBuf);

                const fd = new FormData();
                fd.append('original_filename', CURRENT_FILE);
                fd.append('target_user', target);
                fd.append('encrypted_key', newEnvelopeB64);
                
                await fetch('/share_file', { method:'POST', body:fd });
                log("Link Established.");
                document.getElementById('shareModal').style.display='none';
                showToast("Shared successfully!");
            } catch(e) { log(e.message); alert(e.message); }
        };

        // ==========================================
        // 7. CORE: UPDATE (Preserving Keys)
        // ==========================================
        window.triggerUpdate = async (dataset) => {
            UPDATE_TARGET_FILE = dataset.file;
            const encryptedKeyB64 = dataset.key;
            
            try {
                const privKeyStr = localStorage.getItem("my_private_key");
                const privKey = await importPrivateKey(privKeyStr);
                const keyBuffer = base64ToArrayBuffer(encryptedKeyB64);
                
                const decryptedKeyBuffer = await window.crypto.subtle.decrypt(
                    { name: "RSA-OAEP" },
                    privKey,
                    keyBuffer
                );
                UPDATE_FILE_KEY = new TextDecoder().decode(decryptedKeyBuffer);
                
                document.getElementById('updateInput').click();
            } catch(e) { alert("Authorization Failed: " + e.message); }
        };

        window.confirmUpdate = async () => {
            const fileInput = document.getElementById('updateInput');
            const file = fileInput.files[0];
            if(!file) return;
            
            if(!confirm(`Overwrite archive content? This will sync to all users.`)) { fileInput.value = ''; return; }

            log(`Encrypting update with existing key...`);
            try {
                const raw = new Uint8Array(await file.arrayBuffer());
                // RE-USE THE EXISTING FILE KEY
                const enc = window.wasmEncrypt(raw, UPDATE_FILE_KEY);
                
                const fd = new FormData();
                fd.append('file', new Blob([enc]), file.name); 
                fd.append('filename', UPDATE_TARGET_FILE); 
                
                await fetch('/update_file', { method:'POST', body:fd });

                log("Network Synchronization Complete.");
                setTimeout(() => location.reload(), 1000);
            } catch(e) { log("Sync Error: " + e.message); }
            fileInput.value = '';
        };

        // ==========================================
        // 8. MANAGE
        // ==========================================
        window.openManageModal = async (f) => {
            const modal = document.getElementById('manageModal');
            const list = document.getElementById('userList');
            modal.style.display = 'flex';
            list.innerHTML = "<p style='color:#666'>Scanning permissions...</p>";
            
            try {
                const r = await fetch(`/get_file_users/${f}`);
                const users = await r.json();
                list.innerHTML = "";
                if(users.length === 0) {
                    list.innerHTML = "<p style='color:#666'>No active links.</p>";
                    return;
                }
                users.forEach(u => {
                    if (u.owner_username === CURRENT_USER) return; 
                    const div = document.createElement('div');
                    div.className = 'user-row';
                    div.innerHTML = `
                        <span style="color:#fff">${u.owner_username}</span>
                        <select onchange="changeRole('${u.filename}', this.value)" style="background:#222; color:#fff; padding:5px;">
                            <option value="viewer" ${u.role==='viewer'?'selected':''}>Viewer</option>
                            <option value="editor" ${u.role==='editor'?'selected':''}>Editor</option>
                            <option value="revoked" ${u.role==='revoked'?'selected':''}>Revoke</option>
                        </select>
                    `;
                    list.appendChild(div);
                });
            } catch(e) { list.innerHTML = "Error loading."; }
        };
        
        window.changeRole = async (f, r) => {
            await fetch('/update_role', { 
                method:'POST', 
                headers:{'Content-Type':'application/json'},
                body: JSON.stringify({ filename: f, role: r }) 
            });
            log("Privileges updated.");
        };
    </script>
</body>
</html>